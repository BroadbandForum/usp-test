<!-- <h1 class="display-none" id="sec:mqtt-test-cases">11 MQTT Test Cases<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:mqtt-test-cases" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h1> -->

<h2 id="sec:support-of-required-mqtt-profiles">11.1 Support of Required MQTT Profiles<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:support-of-required-mqtt-profiles" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h2>

<h3 id="sec:purpose-188">Purpose<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:purpose-188" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<p>The purpose of this test is to ensure the EUT supports the required MQTT
profiles.</p>

<h3 id="sec:functionality-tags-99">Functionality Tags<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:functionality-tags-99" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<p>Conditional Mandatory (supports the MQTT MTP)</p>

<h3 id="sec:test-setup-188">Test Setup<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-setup-188" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>Ensure that the EUT and test equipment have the necessary information to send
and receive USP records to each other.</li>
</ol>

<h3 id="sec:test-procedure-181">Test Procedure<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-procedure-181" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li><p>Send a GetSupportedDM message to the EUT with the following structure:</p>

<pre><code filter="pbv" type="Msg">header {
    msg_id: '&lt;msg_id&gt;'
    msg_type: GET_SUPPORTED_DM
}
body {
    request {
        get_supported_dm {
            obj_paths: 'Device.MQTT.'
            obj_paths: 'Device.LocalAgent.'
            return_params: true
            first_level_only: false
        }
    }
}</code></pre></li>
<li><p>Wait for the GetSupportedDMResponse.</p></li>
</ol>

<h3 id="sec:test-metrics-189">Test Metrics<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-metrics-189" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>The EUT sends a GetSupportedDMResponse.</li>
<li>The GetSupportedDMResponse from the EUT contains all required parameters in
the MQTTClientCon:1, MQTTClientSubscribe:1, MQTTAgent:1, and MQTTController:1
data model profiles. The parameter <code>Device.MQTT.Client.{i}.MessageRetryTime</code>
is not required to be supported for EUTs that only implement MQTT version
5.0.</li>
</ol>

<h2 id="sec:mqtt-session-establishment-using-a-connect-packet">11.2 MQTT session establishment using a CONNECT packet<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:mqtt-session-establishment-using-a-connect-packet" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h2>

<h3 id="sec:purpose-189">Purpose<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:purpose-189" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<p>The purpose of this test is to ensure the EUT can properly start an MQTT session
using an MQTT CONNECT packet.</p>

<h3 id="sec:functionality-tags-100">Functionality Tags<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:functionality-tags-100" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<p>Conditional Mandatory (supports the MQTT MTP)</p>

<h3 id="sec:test-setup-189">Test Setup<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-setup-189" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>Ensure that the EUT is configured to use an MQTT server that exists
in the test environment.</li>
<li>Ensure that the EUT data model is configured with
<code>.MQTT.Client.{i}.Username</code>, <code>.MQTT.Client.{i}.Password</code> values.</li>
</ol>

<h3 id="sec:test-procedure-182">Test Procedure<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-procedure-182" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>Reboot the EUT.</li>
<li>Wait for the EUT to reconnect to the MQTT server.</li>
</ol>

<h3 id="sec:test-metrics-190">Test Metrics<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-metrics-190" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>The EUT sends an MQTT CONNECT packet to the MQTT server.<br/></li>
<li>The MQTT CONNECT packet Version is either 5.0 or 3.1.1.</li>
<li>If the EUT uses MQTT 5.0, the MQTT CONNECT packet contains a User Property
name-value pair with name of &ldquo;usp-endpoint-id&rdquo; and value of the EUT USP
Endpoint ID.</li>
<li>The EUT includes User Name and Password fields in the MQTT CONNECT packet.</li>
</ol>

<h2 id="sec:mqtt-use-of-tls">11.3 MQTT Use of TLS<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:mqtt-use-of-tls" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h2>

<h3 id="sec:purpose-190">Purpose<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:purpose-190" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<p>The purpose of this test is to ensure the EUT can establish secure MQTT
communication via TLS.</p>

<h3 id="sec:functionality-tags-101">Functionality Tags<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:functionality-tags-101" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<p>Conditional Mandatory (supports the MQTT MTP)</p>

<h3 id="sec:test-setup-190">Test Setup<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-setup-190" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>Ensure the EUT is configured to use an MQTT server that exists
in the test environment.</li>
<li>Ensure the EUT and MQTT server are configured with the appropriate
certificates to communicate over TLS.</li>
</ol>

<h3 id="sec:test-procedure-183">Test Procedure<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-procedure-183" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li><p>Reboot the EUT</p></li>
<li><p>Wait for the EUT to reconnect to the MQTT server</p></li>
<li><p>Send a Get message to the EUT with the following structure:</p>

<pre><code filter="pbv" type="Msg">header {
    msg_id: '&lt;msg_id&gt;'
    msg_type: GET
}
body {
    request {
        get {
            param_paths: 'Device.DeviceInfo'
        }
    }
}</code></pre></li>
<li><p>Wait for the EUT to send a GetResponse</p></li>
</ol>

<h3 id="sec:test-metrics-191">Test Metrics<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-metrics-191" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>All communication between the EUT and MQTT server after step 1 are encrypted
using TLS 1.2 or later.</li>
</ol>

<h2 id="sec:mqtt-5.0-clientid">11.4 MQTT 5.0 ClientID<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:mqtt-5.0-clientid" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h2>

<h3 id="sec:purpose-191">Purpose<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:purpose-191" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<p>The purpose of this test is to ensure the EUT properly sets the ClientID field
in MQTT packets.</p>

<h3 id="sec:functionality-tags-102">Functionality Tags<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:functionality-tags-102" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<p>Conditional Mandatory (supports the MQTT MTP, version 5.0)</p>

<h3 id="sec:test-setup-191">Test Setup<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-setup-191" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>Ensure that the EUT is configured to use an MQTT server that exists in the
test environment.</li>
</ol>

<h3 id="sec:test-procedure-184">Test Procedure<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-procedure-184" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li><p>Send a Set message to the EUT with the following structure:</p>

<pre><code filter="pbv" type="Msg">header {
  msg_id: '&lt;msg_id&gt;'
  msg_type: SET
}

body {
  request {
    set {
      allow_partial: false
      update_objs {
        obj_path: 'Device.​MQTT.​Client.&lt;active MQTT client instance&gt;.'
        param_settings {
         param: 'ClientID'
         value: ''
         required: true
        }
      }
    }
  }
}</code></pre></li>
<li><p>Reboot the EUT.</p></li>
<li><p>Wait for the EUT to reconnect to the MQTT server.</p></li>
<li><p>The MQTT server sends an MQTT CONNACK packet with an Assigned Client
Identifier.</p></li>
<li><p>Send a Get message to the EUT with the following structure:</p>

<pre><code filter="pbv" type="Msg">header {
  msg_id: '&lt;msg_id&gt;'
  msg_type: GET
}
body {
  request {
    get {
      param_paths: 'Device.​MQTT.​Client.&lt;active MQTT client instance&gt;.ClientID'
    }
  }
}</code></pre></li>
</ol>

<h3 id="sec:test-metrics-192">Test Metrics<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-metrics-192" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>The EUT MQTT CONNECT packet must include a ClientID set to an empty string.</li>
<li>The retrieved value of ClientID matches the Assigned Client Identifier from
step 4.</li>
</ol>

<h2 id="sec:mqtt-clientid-persistence">11.5 MQTT ClientID Persistence<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:mqtt-clientid-persistence" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h2>

<h3 id="sec:purpose-192">Purpose<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:purpose-192" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<p>The purpose of this test is to ensure the MQTT ClientID field persists after
successful connection with an MQTT server.</p>

<h3 id="sec:functionality-tags-103">Functionality Tags<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:functionality-tags-103" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<p>Conditional Mandatory (supports the MQTT MTP)</p>

<h3 id="sec:test-setup-192">Test Setup<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-setup-192" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>Ensure that the EUT is configured to use an MQTT server that exists in the
test environment.</li>
</ol>

<h3 id="sec:test-procedure-185">Test Procedure<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-procedure-185" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li><p>Send a Get message to the EUT with the following structure:</p>

<pre><code filter="pbv" type="Msg">header {
  msg_id: '&lt;msg_id&gt;'
  msg_type: GET
}
body {
  request {
    get {
      param_paths: 'Device.​MQTT.​Client.&lt;active MQTT client instance&gt;.ClientID'
    }
  }
}</code></pre></li>
<li><p>Reboot the EUT.</p></li>
<li><p>Wait for the EUT to reconnect to the MQTT server.</p></li>
</ol>

<h3 id="sec:test-metrics-193">Test Metrics<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-metrics-193" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>The EUT uses the same ClientID in the subsequent MQTT CONNECT packet.</li>
</ol>

<h2 id="sec:mqtt-message-retry">11.6 MQTT Message Retry<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:mqtt-message-retry" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h2>

<h3 id="sec:purpose-193">Purpose<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:purpose-193" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<p>The purpose of this test is to ensure the EUT properly enters a retry state
when it fails to connect to the MQTT server.</p>

<h3 id="sec:functionality-tags-104">Functionality Tags<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:functionality-tags-104" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<p>Conditional Mandatory (supports the MQTT MTP)</p>

<h3 id="sec:test-setup-193">Test Setup<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-setup-193" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>Ensure the EUT is configured to use an MQTT server that is part of the test
environment.</li>
</ol>

<h3 id="sec:test-procedure-186">Test Procedure<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-procedure-186" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li><p>Send a Get message to the EUT with the following structure</p>

<pre><code filter="pbv" type="Msg">header {
    msg_id: '&lt;msg_id&gt;'
    msg_type: GET
}
body {
    request {
        get {
            param_paths: 'Device.MQTT.Client.'
        }
    }
}</code></pre></li>
<li><p>Send an Operate message to the EUT with the following structure:</p>

<pre><code filter="pbv" type="Msg">header {
    msg_id: '&lt;msg_id&gt;'
    msg_type: OPERATE
}
body {
    request {
        operate {
            command: 'Device.Reboot()'
        }
    }
}</code></pre></li>
<li><p>Disable the MQTT server.</p></li>
<li><p>Allow the EUT to attempt to start an MQTT session with the MQTT server.</p></li>
<li><p>Reenable the MQTT server after the EUT fails to connect to the MQTT server
twice.</p></li>
</ol>

<h3 id="sec:test-metrics-194">Test Metrics<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-metrics-194" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>The EUT retries connecting to the MQTT server within the <code>ConnectRetryTime</code>
of the connection instance.</li>
<li>The EUT retries a second time in accordance with <code>ConnectRetryTime</code> and
<code>ConnectRetryIntervalMultiplier</code>.</li>
</ol>

<h2 id="sec:mqtt-keep-alive">11.7 MQTT Keep Alive<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:mqtt-keep-alive" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h2>

<h3 id="sec:purpose-194">Purpose<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:purpose-194" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<p>The purpose of this test is to ensure the EUT can correctly implement the MQTT
keep alive mechanism and the relevant parameters in the data model.</p>

<h3 id="sec:functionality-tags-105">Functionality Tags<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:functionality-tags-105" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<p>Conditional Mandatory (supports the MQTT MTP, version 5.0)</p>

<h3 id="sec:test-setup-194">Test Setup<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-setup-194" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>The EUT is configured to use an MQTT server which exists in the test
environment.</li>
</ol>

<h3 id="sec:test-procedure-187">Test Procedure<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-procedure-187" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li><p>Send a Set message to the EUT with the following structure:</p>

<pre><code filter="pbv" type="Msg">header {
    msg_id: '&lt;msg_id&gt;'
    msg_type: SET
}
body {
    request {
        set {
            update_objs {
                    obj_path: 'Device.​MQTT.​Client.​&lt;active MQTT client instance&gt;.'
                    param_settings {
                            param: 'KeepAliveTime'
                            value: '60'
                        }
                }
        }
    }
}</code></pre></li>
<li><p>Reboot the EUT.</p></li>
<li><p>Wait for the EUT to reconnect to the MQTT server.</p></li>
<li><p>The MQTT server sends an MQTT CONNACK packet with a Keep Alive value of 30
seconds.</p></li>
<li><p>Wait 45 seconds.</p></li>
</ol>

<h3 id="sec:test-metrics-195">Test Metrics<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-metrics-195" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>The EUT sends an MQTT CONNECT packet on boot with the Keep Alive property set
to 60 seconds.</li>
<li>The EUT sends an MQTT PINGREQ packet within 45 seconds of the last MQTT
message. This represents 1.5 times the Keep Alive value.</li>
</ol>

<h2 id="sec:mqtt-subscribe-packet">11.8 MQTT SUBSCRIBE Packet<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:mqtt-subscribe-packet" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h2>

<h3 id="sec:purpose-195">Purpose<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:purpose-195" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<p>The purpose of this test is to ensure the EUT includes the correct fields in an
MQTT SUBSCRIBE packet.</p>

<h3 id="sec:functionality-tags-106">Functionality Tags<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:functionality-tags-106" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<p>Conditional Mandatory (supports the MQTT MTP, version 5.0)</p>

<h3 id="sec:test-setup-195">Test Setup<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-setup-195" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>Ensure that the EUT is configured to use an MQTT server that exists
in the test environment.</li>
</ol>

<h3 id="sec:test-procedure-188">Test Procedure<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-procedure-188" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>Reboot the EUT.</li>
<li>Wait for the EUT to reconnect to the MQTT server.</li>
<li>The MQTT server sends an MQTT CONNACK packet containing a User Property of
subscribe-topic.</li>
<li>For an EUT using MQTT 5.0, the MQTT CONNACK packet contains a Response
Information property.</li>
<li>Wait for the EUT to send an MQTT SUBSCRIBE packet.</li>
</ol>

<h3 id="sec:test-metrics-196">Test Metrics<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-metrics-196" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>The EUT sends an MQTT CONNECT packet to the MQTT server. If the EUT uses MQTT
5.0, the Request Response Information property must be set to 1.</li>
<li>The EUT sends an MQTT SUBSCRIBE packet to the MQTT server. The MQTT SUBSCRIBE
packet includes the subscribe-topic sent in step 3.</li>
<li>If the EUT uses MQTT 5.0, the MQTT SUBSCRIBE packet includes the Response
Information property sent in step 4.</li>
</ol>

<h2 id="sec:mqtt-new-subscription">11.9 MQTT New Subscription<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:mqtt-new-subscription" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h2>

<h3 id="sec:purpose-196">Purpose<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:purpose-196" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<p>The purpose of this test is to ensure the EUT sends an MQTT SUBSCRIBE packet
when a new <code>Device.MQTT.Client.{i}.Subscription.{i}.</code> object is added.</p>

<h3 id="sec:functionality-tags-107">Functionality Tags<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:functionality-tags-107" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<p>Conditional Mandatory (supports MQTT MTP)</p>

<h3 id="sec:test-setup-196">Test Setup<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-setup-196" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>Ensure that the EUT is configured to use an MQTT server that exists
in the test environment.</li>
</ol>

<h3 id="sec:test-metrics-197">Test Metrics<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-metrics-197" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li><p>Send an Add message to the EUT with the following structure:</p>

<pre><code filter="pbv" type="Msg">header {
    msg_id: '&lt;msg_id&gt;'
    msg_type: ADD
}
body {
    request {
        add {
          allow_partial: false
          create_objs {
              obj_path: 'Device.MQTT.Client.&lt;active MQTT client instance&gt;.Subscription.'
              param_settings {
                      param: 'Enable'
                      value: 'true'
                  }
              param_settings {
                      param: 'Topic'
                      value: 'newTopic-11-9'
                  }
              }
        }
    }
}</code></pre></li>
<li><p>Wait for the EUT to send an MQTT SUBSCRIBE packet.</p></li>
<li><p>The MQTT server sends an MQTT SUBACK packet indicating the QoS level that was
granted for the subscription.</p></li>
<li><p>Send a Get message with topic <code>newTopic-11-9</code> with the following structure:</p>

<pre><code filter="pbv" type="Msg">header {
  msg_id: '&lt;msg_id&gt;'
  msg_type: GET
}
body {
  request {
    get {
      param_paths: 'Device.MQTT.Client.&lt;active MQTT client instance&gt;.Subscription.&lt;instance identifier from step 1&gt;.'
    }
  }
}</code></pre></li>
<li><p>Send a Set message to the EUT with the following structure:</p>

<pre><code filter="pbv" type="Msg">header {
  msg_id: "&lt;msg_id&gt;"
  msg_type: SET
}

body {
  request {

    set {
      allow_partial: false
      update_objs {
        obj_path: "Device.MQTT.Client.&lt;active MQTT client instance&gt;.Subscription.&lt;instance identifier from step 1&gt;"
        param_settings: {
         param: "Enable"
         value: "false"
         required: true
        }
      }
    }
  }
}</code></pre></li>
<li><p>The MQTT Server sends an MQTT UNSUBACK packet indicating success.</p></li>
</ol>

<h3 id="sec:test-metrics-198">Test Metrics<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-metrics-198" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>The EUT sends an MQTT SUBSCRIBE packet that includes the new Topic from step 1.</li>
<li>The EUT sends a GetResp for the Subscription.</li>
<li>The EUT sends an MQTT UNSUBSCRIBE packet for the configured Topic after Enable
is set to false.</li>
</ol>

<h2 id="sec:mqtt-no-topic-in-connack">11.10 MQTT No Topic in CONNACK<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:mqtt-no-topic-in-connack" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h2>

<h3 id="sec:purpose-197">Purpose<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:purpose-197" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<p>The purpose of this test is to ensure the EUT will disconnect from the MQTT
server if it receives no subscribe-topic.</p>

<h3 id="sec:functionality-tags-108">Functionality Tags<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:functionality-tags-108" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<p>Conditional Mandatory (supports the MQTT MTP, version 5.0)</p>

<h3 id="sec:test-setup-197">Test Setup<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-setup-197" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>Ensure that the EUT is configured to use an MQTT server that exists
in the test environment.</li>
<li>Ensure that all instances of <code>Device.MQTT.Client.&lt;active MQTT client instance&gt;.Subscription.</code>
are removed from the EUT.</li>
</ol>

<h3 id="sec:test-procedure-189">Test Procedure<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-procedure-189" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>Reboot the EUT.</li>
<li>Wait for the EUT to reconnect to the MQTT server.</li>
<li>The MQTT server sends an MQTT CONNACK packet that does not include a
subscribe-topic User Property.</li>
</ol>

<h3 id="sec:test-metrics-199">Test Metrics<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-metrics-199" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>The EUT sends an MQTT DISCONNECT packet to the MQTT server.</li>
</ol>

<h2 id="sec:mqtt-failure-to-subscribe">11.11 MQTT Failure to Subscribe<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:mqtt-failure-to-subscribe" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h2>

<h3 id="sec:purpose-198">Purpose<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:purpose-198" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<p>The purpose of this test is to ensure the EUT will disconnect from the MQTT
server if it is unable to subscribe to a Topic.</p>

<h3 id="sec:functionality-tags-109">Functionality Tags<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:functionality-tags-109" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<p>Conditional Mandatory (supports the MQTT MTP)</p>

<h3 id="sec:test-setup-198">Test Setup<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-setup-198" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>Ensure that the EUT is configured to use an MQTT server that exists
in the test environment.</li>
</ol>

<h3 id="sec:test-procedure-190">Test Procedure<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-procedure-190" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>Reboot the EUT.</li>
<li>Wait for the EUT to send an MQTT SUBSCRIBE packet.</li>
<li>The MQTT server sends an MQTT SUBACK packet that includes an error for each
Topic in the SUBSCRIBE packet.</li>
</ol>

<h3 id="sec:test-metrics-200">Test Metrics<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-metrics-200" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>The EUT sends an MQTT DISCONNECT packet to the MQTT server.</li>
</ol>

<h2 id="sec:mqtt-publish-packet">11.12 MQTT PUBLISH Packet<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:mqtt-publish-packet" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h2>

<h3 id="sec:purpose-199">Purpose<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:purpose-199" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<p>The purpose of this test is to ensure the EUT can send a properly formatted an
MQTT PUBLISH packet.</p>

<h3 id="sec:functionality-tags-110">Functionality Tags<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:functionality-tags-110" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<p>Conditional Mandatory (supports the MQTT MTP)</p>

<h3 id="sec:test-setup-199">Test Setup<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-setup-199" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>Ensure the EUT is configured to use an MQTT server that exists
in the test environment.</li>
</ol>

<h3 id="sec:test-procedure-191">Test Procedure<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-procedure-191" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li><p>Reboot the EUT.</p></li>
<li><p>Wait for the EUT to reconnect to the MQTT server.</p></li>
<li><p>The MQTT server sends a CONNACK packet.</p></li>
<li><p>For an EUT using MQTT 5.0, the CONNACK packet contains a Response
Information property.</p></li>
<li><p>Send a Get message to the EUT with the following structure:</p>

<pre><code filter="pbv" type="Msg">header {
    msg_id: '&lt;msg_id&gt;'
    msg_type: GET
}
body {
    request {
        get {
            param_paths: 'Device.DeviceInfo'
        }
    }
}</code></pre></li>
<li><p>Wait for the EUT to send a GetResponse</p></li>
</ol>

<h3 id="sec:test-metrics-201">Test Metrics<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-metrics-201" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>The EUT sends an MQTT PUBLISH packet containing a GetResponse.</li>
<li>If the EUT uses MQTT 5.0, the Response Topic is set to the Response
Information property from step 4.</li>
<li>If the EUT uses MQTT 3.1.1, the &ldquo;reply to&rdquo; is included after <code>/reply-to=</code> at
the end of the PUBLISH Topic Name, with any <code>/</code> character in the Topic
replaced by <code>%2F</code>.</li>
<li>If the EUT uses MQTT 5.0, the Content Type property is set to <code>usp.msg</code></li>
</ol>

<h2 id="sec:mqtt-qos">11.13 MQTT QoS<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:mqtt-qos" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h2>

<h3 id="sec:purpose-200">Purpose<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:purpose-200" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<p>The purpose of this test is to ensure the EUT supports at least MQTT QoS levels
0 and 1.</p>

<h3 id="sec:functionality-tags-111">Functionality Tags<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:functionality-tags-111" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<p>Conditional Mandatory (supports the MQTT MTP)</p>

<h3 id="sec:test-setup-200">Test Setup<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-setup-200" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>Ensure the EUT is configured to use an MQTT server that exists
in the test environment.</li>
</ol>

<h3 id="sec:test-procedure-192">Test Procedure<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-procedure-192" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li><p>Send an Add message to the EUT with the following structure:</p>

<pre><code filter="pbv" type="Msg">header {
    msg_id: '&lt;msg_id&gt;'
    msg_type: ADD
}
body {
    request {
        add {
          allow_partial: false
          create_objs {
              obj_path: 'Device.MQTT.Client.&lt;active MQTT client instance&gt;.Subscription.'
              param_settings {
                      param: 'Enable'
                      value: 'true'
                  }
              param_settings {
                      param: 'Topic'
                      value: 'newTopic-11-13-QoS0'
                  }
              }
        }
    }
}</code></pre></li>
<li><p>Wait for the EUT to send an MQTT SUBSCRIBE packet.</p></li>
<li><p>The MQTT server sends an MQTT SUBACK packet indicating a QoS level of 0 for
the subscription.</p></li>
<li><p>Send an Add message to the EUT with the following structure:</p>

<pre><code filter="pbv" type="Msg">header {
    msg_id: '&lt;msg_id&gt;'
    msg_type: ADD
}
body {
    request {
        add {
          allow_partial: false
          create_objs {
              obj_path: 'Device.MQTT.Client.&lt;active MQTT client instance&gt;.Subscription.'
              param_settings {
                      param: 'Enable'
                      value: 'true'
                  }
              param_settings {
                      param: 'Topic'
                      value: 'newTopic-11-13-QoS1'
                  }
              param_settings {
                      param: 'QoS'
                      value: '1'
                  }
              }
        }
    }
}</code></pre></li>
<li><p>The MQTT server sends an MQTT SUBACK packet indicating a QoS level of 1 for the
subscription.</p></li>
<li><p>Send a Get message with topic &lsquo;newTopic-11-13-QoS0&rsquo; to the EUT with the following structure:</p>

<pre><code filter="pbv" type="Msg">header {
  msg_id: '&lt;msg_id&gt;'
  msg_type: GET
}
body {
  request {
    get {
      param_paths: 'Device.MQTT.Client.&lt;active MQTT client instance&gt;.Subscription.&lt;instance from step 1&gt;.'
    }
  }
}</code></pre></li>
<li><p>Send a Get message with topic &lsquo;newTopic-11-13-QoS1&rsquo; to the EUT with the following structure:</p>

<pre><code filter="pbv" type="Msg">header {
  msg_id: '&lt;msg_id&gt;'
  msg_type: GET
}
body {
  request {
    get {
      param_paths: 'Device.MQTT.Client.&lt;active MQTT client instance&gt;.Subscription.&lt;instance from step 4&gt;.'
    }
  }
}</code></pre></li>
</ol>

<h3 id="sec:test-metrics-202">Test Metrics<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-metrics-202" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>The EUT sends a GetResp for the Get message sent to topic &lsquo;newTopic-11-13-QoS0&rsquo;.</li>
<li>The EUT sends a GetResp for the Get message sent to topic &lsquo;newTopic-11-13-QoS1&rsquo;.</li>
</ol>

<h2 id="sec:mqtt-reply-to-topic">11.14 MQTT Reply to Topic<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:mqtt-reply-to-topic" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h2>

<h3 id="sec:purpose-201">Purpose<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:purpose-201" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<p>The purpose of this test is to ensure the EUT can process and set the &ldquo;reply to&rdquo; Topic in MQTT PUBLISH packets.</p>

<h3 id="sec:functionality-tags-112">Functionality Tags<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:functionality-tags-112" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<p>Conditional Mandatory (supports the MQTT MTP)</p>

<h3 id="sec:test-setup-201">Test Setup<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-setup-201" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>Ensure the EUT is configured to use an MQTT server that exists
in the test environment.</li>
</ol>

<h3 id="sec:test-procedure-193">Test Procedure<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-procedure-193" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li><p>Send a Get message to the EUT with the following structure:</p>

<pre><code filter="pbv" type="Msg">header {
    msg_id: '&lt;msg_id&gt;'
    msg_type: GET
}
body {
    request {
        get {
            param_paths: 'Device.DeviceInfo'
        }
    }
}</code></pre></li>
<li><p>Wait for the EUT to send a GetResponse.</p></li>
</ol>

<h3 id="sec:test-metrics-203">Test Metrics<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-metrics-203" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>If the EUT uses MQTT 5.0, the EUT must send an MQTT PUBLISH packet that
includes a GetResponse. The Topic Name must be set to the &ldquo;reply to&rdquo; Topic
from the controller’s MQTT PUBLISH packet Response Topic property. The EUT
must include a Response Topic property that has a &ldquo;reply to&rdquo; Topic set.</li>
<li>If the EUT uses MQTT 3.1.1, the EUT must send an MQTT PUBLISH packet that
includes a GetResponse. The Topic must be set to the reply to topic at the
end of the Topic Name in the Controller’s MQTT PUBLISH packet. All instances
of <code>%2F</code> must be replaced by <code>/</code> in the Topic Name. The EUT must set a reply
to topic by including it at the end of the Topic Name after <code>/reply-to=</code> and replacing all instances of <code>/</code> with <code>%2F</code>.</li>
</ol>

<h2 id="sec:mqtt-5.0-content-type">11.15 MQTT 5.0 Content Type<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:mqtt-5.0-content-type" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h2>

<h3 id="sec:purpose-202">Purpose<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:purpose-202" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<p>The purpose of this test is to ensure the EUT can accept valid values of the
MQTT Content Type property.</p>

<h3 id="sec:functionality-tags-113">Functionality Tags<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:functionality-tags-113" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<p>Conditional Mandatory (supports the MQTT MTP, version 5.0)</p>

<h3 id="sec:test-setup-202">Test Setup<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-setup-202" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>Ensure the EUT is configured to use an MQTT server that exists
in the test environment.</li>
</ol>

<h3 id="sec:test-procedure-194">Test Procedure<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-procedure-194" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li><p>Configure the Controller to include an MQTT Content Type property of <code>usp.msg</code>
in its MQTT packets.</p></li>
<li><p>Send a Get message to the EUT with the following structure:</p>

<pre><code filter="pbv" type="Msg">header {
    msg_id: '&lt;msg_id&gt;'
    msg_type: GET
}
body {
    request {
        get {
            param_paths: 'Device.DeviceInfo'
        }
    }
}</code></pre></li>
<li><p>Wait for the EUT to send a GetResponse.</p></li>
<li><p>Configure the Controller to include an MQTT Content Type property of
<code>application/vnd.bbf.usp.msg</code> in its MQTT packets.</p></li>
<li><p>Send a Get message to the EUT with the following structure:</p>

<pre><code filter="pbv" type="Msg">header {
    msg_id: '&lt;msg_id&gt;'
    msg_type: GET
}
body {
    request {
        get {
            param_paths: 'Device.DeviceInfo'
        }
    }
}</code></pre></li>
<li><p>Wait for the EUT to send a GetResponse.</p></li>
</ol>

<h3 id="sec:test-metrics-204">Test Metrics<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-metrics-204" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>The EUT must send a GetResponse for both Get messages, indicating that it
processed the Controller’s MQTT PUBLISH packets.</li>
</ol>

<h2 id="sec:mqtt-connection-retry">11.16 MQTT Connection Retry<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:mqtt-connection-retry" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h2>

<h3 id="sec:purpose-203">Purpose<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:purpose-203" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<p>The purpose of this test is to ensure the EUT retries its connection with the
MQTT server after the server terminates the connection.</p>

<h3 id="sec:functionality-tags-114">Functionality Tags<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:functionality-tags-114" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<p>Conditional Mandatory (supports the MQTT MTP)</p>

<h3 id="sec:test-setup-203">Test Setup<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-setup-203" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>Ensure the EUT is configured to use an MQTT server that exists
in the test environment.</li>
</ol>

<h3 id="sec:test-procedure-195">Test Procedure<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-procedure-195" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>Send an MQTT DISCONNECT packet to the EUT.</li>
<li>Allow the EUT to start a new MQTT session with the MQTT server.</li>
</ol>

<h3 id="sec:test-metrics-205">Test Metrics<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-metrics-205" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>The EUT retries connecting to the MQTT server between ConnectRetryTime of the
connection instance and
ConnectRetryTime*(ConnectRetryIntervalMultiplier/1000).</li>
</ol>

<h2 id="sec:mqtt---use-of-connect-record">11.17 MQTT - Use of Connect Record<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:mqtt---use-of-connect-record" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h2>

<h3 id="sec:purpose-204">Purpose<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:purpose-204" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<p>The purpose of this test is to ensure the EUT correctly sends a Connect record
after it has established a communications channel to the controller.</p>

<h3 id="sec:functionality-tags-115">Functionality Tags<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:functionality-tags-115" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<p>Conditional Mandatory (supports the MQTT MTP)</p>

<h3 id="sec:test-setup-204">Test Setup<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-setup-204" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>Ensure the EUT is configured to use an MQTT server that exists
in the test environment.</li>
</ol>

<h3 id="sec:test-procedure-196">Test Procedure<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-procedure-196" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>Reboot the EUT.</li>
<li>Wait for the EUT to establish an MQTT session with the MQTT server.</li>
</ol>

<h3 id="sec:test-metrics-206">Test Metrics<a class="headerlink" href="12-index-mqtt-test-cases.html#sec:test-metrics-206" title="Permalink to this header"> <img src='permalink.png' title='' width="0.8em"/></a></h3>

<ol>
<li>After reconnecting to the MQTT server, the EUT transmits an MQTTConnectRecord
within 30 seconds. The EUT includes the MQTTVersion field set to the correct
MQTT version and the subscribed_topic field set to a Topic that the EUT is
subscribed to.</li>
</ol>
